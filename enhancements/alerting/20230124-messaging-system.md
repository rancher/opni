# Title:

Alerting Cluster as a Plain Messaging System

## Summary:

Opni Alerting plugin only evaluates and sends alarms. The Opni-Alerting cluster should send messages from other Opni backends to endpoints of the User's choice.

## Use case:

- Opni backends, for example, AiOps require a way to send `Plain` messages to the end user.
- Users want to set default endpoints to receive notifications on
- Users should have a way to see received messages even if they have no endpoints configured

## Benefits:

- Allows any service in the opni ecosystem to send pertinent messages to users
- Provide a way to set default endpoints on messages generated by Opni-Alerting
- Always persist a small amount of the most important messages generated, for end-user UX

## Impact:

## Implementation details:

![](./images/alerting-messaging-system-proposal.png)

### Setting Defaults

- `AlertEndpoint` protocol buffer messages have a default flag
- `OpsServer` reconciles default endpoints to `OpniRouter` interfaces in the Alerting Cluster, building the default endpoints into the router through calling the existing method `SetDefaultNamespace(defaultEndpointList)`

### Persisting messages

- The global default receiver `opni.default.hook`, present in the `Opni Embedded Server`, already receives all alert messages, so for persisting messages, this server serves two in memory `hashicorp` LRU caches (with keys ordered by frequency to implement LFU) over objects of the type `github.com/prometheus/alertmanager/notify/webhook`.`WebhookMessage`

### Pushing messages

- The Trigger sends messages to the AlertingCluster, through wrapped AlertManager adapter calls, from the follow service descriptor:

```proto
service AlertTriggers {
  //...
  rpc PushMessage(PlainMessage) returns (google.protobuf.Empty) {}
  //...
}

message PlainMessage {
  // required : title of the message
  string title = 1;
  // required : (HTML renderable) body of the message
  string body = 2;
  // optional, defaults to info
  alerting.OpniSeverity severity = 3;
  // optional rate limiting key set by the caller
  string key = 4;
}
```

### List messages

- The trigger server implements `ListMessages` which reads the data held in caches, and returns them in a human readable format for the CLI/UI

### UI

- Right Click set as default on endpoints on the AlertEndpoint page
- Display two lists, for example of 25 maximum each, of structured messages (`Plain` / `Alarm`) that can contain HTML

## Acceptance criteria:

- [ ] Gateway push message API, consumable by Opni backends
- [ ] Setting a set of Default Endpoints
- [ ] A small in memory priority LFU cache based on severity to store `Alarm` messages
- [ ] A small in memory priority LFU cache based on severity to store `Plain` messages
- [ ] Gateway API to read messages stored in cache

## Supporting documents:

- https://github.com/rancher/opni/wiki/Alerting-Routing-Model

## Dependencies:

- Opni Router interface : https://github.com/rancher/opni/pull/942

## Risks and contingencies:

## Level of Effort:

2 weeks

- 3 days : interceptors
- 2 days : default endpoints
- 2 days : push messages
- 3 days : message persistence & listing

## Resources:

1 Opni Upstream Cluster
